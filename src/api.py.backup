# Backup of api.py
# Saved on 2025-07-24

import os
import io
import sys
import traceback
from datetime import datetime
import yaml
import numpy as np
import torch
import torch.nn as nn
import torch.nn.functional as F  # Re-added import for functional API
from scipy import ndimage  # Added import for ndimage module used in edge_precision calculation
import cv2  # Added for heatmap generation

# Add src to path for imports
current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.insert(0, current_dir)

try:
    import timm
    TIMM_AVAILABLE = True
except ImportError:
    print("⚠️ timm not found, using basic model")
    timm = None
    TIMM_AVAILABLE = False

try:
    from explainer import ExplainabilityAnalyzer
    EXPLAINER_AVAILABLE = True
    print("✅ ExplainabilityAnalyzer loaded successfully")
except ImportError as e:
    print(f"⚠️ ExplainabilityAnalyzer not available: {e}")
    EXPLAINER_AVAILABLE = False

from fastapi import FastAPI, File, UploadFile, HTTPException
from fastapi.staticfiles import StaticFiles
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.middleware.cors import CORSMiddleware
from PIL import Image
matplotlib.use('Agg')  # Use non-interactive backend
from product_knowledge import ProductAnalyzer

...existing code...
